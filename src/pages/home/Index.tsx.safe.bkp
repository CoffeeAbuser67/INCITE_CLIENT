// HERE Home
import React, {
  useState,
  useCallback,
  useRef,
  useEffect,
  useMemo,
} from "react";

import classNames from "classnames";

import {
  Box,
  Card,
  Flex,
  Avatar,
  Text,
  IconButton,
  Table,
  Badge,
  Heading,
  AlertDialog,
  Button,
  Tabs,
  ScrollArea,
  TextField,
  TextArea,
  Dialog,
  Separator,
  Strong,
  DropdownMenu,
} from "@radix-ui/themes";
import { axiosPlain } from "../../utils/axios";
import handleAxiosError from "../../utils/handleAxiosError";
import { useWindowResize } from "../../hooks/useWindowResize";

import {
  PieChart,
  Pie,
  BarChart,
  Bar,
  Cell,
  LabelList,
  LineChart,
  Line,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer,
  Rectangle,
  ReferenceArea,
  Label,
  Brush
} from 'recharts';

import { TooltipProps } from "recharts";
import MapMenu from "./MapMenu2";
import Icons from "../../assets/Icons";
import ICON_SIZES from "../../assets/IconsSizes";

import { VARIABLES, COLORSHEX, SCOLORS } from "../../assets/auxData";
import { mapStore, variableStore, yearStore } from "../../store/mapsStore";
// . . . . . . .


//  WARN Xique-xique | santa teresinha | Muquém de São Francisco
// 
const Home = () => { // ★  ⋙── ── ── ── ── ── Home ── ── ── ── ── ── ── ── ──➤ 

  // ✳ [windowSize, setWindowSize]
  const [windowSize, setWindowSize] = useState({ width: 0, height: 0 });
  useWindowResize((width, height) => {
    setWindowSize({ width, height });
  });

  // ✳ {region, city} 
  const { region, city } = mapStore();

  //  ✳ {year}
  const { year } = yearStore();

  //  ✳ {variable}
  const { variable } = variableStore();

  type A_Item = { id: string; name: string; v: number };
  type A_Item2 = { id: string; name: string; qp: number, rm: number };
  type AgriculturalData = {
    data: A_Item[];
    percent_data: A_Item[];
    QP_RM: A_Item2[];
    var: string;
  };

  //  ✳ [topVData, setTopVData]
  const [topVData, setTopVData] = useState<AgriculturalData | null>(null);

  type DataS = {
    [key: string]: number;
    year: number;
  };

  type DataSeries = {
    data: DataS[]
    keys: { [key: string]: string };
  };

  //  ✳ [seriesVData, setSeriesVData]
  const [seriesVData, setSeriesVData] = useState<DataSeries | null>(null);
  // ── ⋙── ── ── ── ── ── ── ──➤

  const seriesKeys = seriesVData?.keys ? Object.keys(seriesVData?.keys) : [] // HERE seriesKeys

  useEffect(() => {   // HERE useEffect
    getSeriesValues()
  }, [region, city, variable])

  useEffect(() => {   // HERE useEffect
    getTopValues()
  }, [region, city, year, variable])
  // ── ⋙── ── ── ── ── ── ── ──➤

  const getSeriesValues = async () => { // {✪} getSeriesValues
    const axios = axiosPlain;
    try {
      const area = city.active === '' ? region.active : city.active
      const TYPE = city.active === '' ? "regiao" : "municipio"
      const url = "/getTopSeries/";
      const params = {
        area: area,
        variable: variable,
        type: TYPE
      };

      const response = await axios.get(url, { params }); // _PIN_ getTopSeries  ✉ 
      setSeriesVData(response.data); // ↺ setSeriesVData



      console.log('%c ◯⫘⫘⫘⫘⫘⫘⫘⫘⫘⫘⫘⫘⫘⫸ 🩸', 'color: red; font-size: 16px; font-weight: bold;');
      console.log('seriesVData:', response.data); // [LOG] seriesVData
      console.log('%c ◯⫘⫘⫘⫘⫘⫘⫘⫘⫘⫘⫘⫘⫘⫸ 🩸', 'color: red; font-size: 16px; font-weight: bold;');






    } catch (err: unknown) {
      if (err) {
        handleAxiosError(err);
      }
    }
  } // ── ⋙── ── ── ── ── ── ── ──➤

  const getTopValues = async () => { // (✪) getTopValues
    const axios = axiosPlain;
    try {

      const area = city.active === '' ? region.active : city.active
      const TYPE = city.active === '' ? "regiao" : "municipio"

      const url = "/getTopValues/";
      const params = {
        year: year,
        area: area,
        variable: variable,
        type: TYPE
      };

      const response = await axios.get(url, { params }); // _PIN_ getTopValues  ✉ 
      setTopVData(response.data); // ↺ setTopVData

    } catch (err: unknown) {
      if (err) {
        handleAxiosError(err);
      }
    }
  } // ── ⋙── ── ── ── ── ── ── ──➤

  const PieTooltip: React.FC<TooltipProps<number, string>> = ({ active, payload }) => {   // <●> PieTooltip
    if (active && payload && payload.length) {
      const { id, name, v } = payload[0].payload; // Extract id from payload

      const SvgComponent = Icons[id as keyof typeof Icons];
      if (!SvgComponent) return null;

      return (
        <Card>
          <SvgComponent />
          <span>{`${name}: ${v.toFixed(2)}%`}</span>
        </Card>
      );
    }
    return null;
  }; // . . . . . . . . . . . .

  const BarTooltip: React.FC<TooltipProps<number, string>> = ({ active, payload }) => {  // (●) BarTooltip
    if (active && payload && payload.length) {
      const { name, v } = payload[0].payload; // Extract id from payload
      return (
        <Card>
          <Text as="div"> <Strong>{`${name}`}</Strong> </Text>
          <div>{`${v.toLocaleString('de-DE')} R$`}</div>
        </Card>
      );
    }
    return null;
  }; // . . .

  const BarTopLabels = (props) => {  // (●) BarTopLabels
    const { x, y, width, index } = props;
    const dataName = topVData?.data[index]?.id ?? "default"; // ⊙ topVData
    const SvgComponent = Icons[dataName as keyof typeof Icons];
    if (!SvgComponent) return null;
    const { w: svgWidth, h: svgHeight } = ICON_SIZES[dataName] || { w: 30, h: 30 };
    const centerX = x + (width / 2) - (svgWidth / 2); // Position at the middle of the bar
    const centerY = y - svgHeight; // Position at the **exact top** of the bar

    return <SvgComponent x={centerX} y={centerY} />;
  }; // . . .

  const QMRMTooltip: React.FC<TooltipProps<number, string>> = ({ active, payload }) => {  // {●} QMRMTooltip
    if (active && payload && payload.length) {
      const { name, qp, rm } = payload[0].payload;

      return (
        <Card>
          <Text as="div"> <Strong>{`${name}`}</Strong> </Text>
          <Text size='3' as="div"> Quantidade Produzida: <Strong>{qp.toLocaleString('de-DE')}</Strong> Toneladas* </Text>
          <Text as="div"> Rendimento Médio: <Strong>{rm.toLocaleString('de-DE')}</Strong> Kg/Hectares </Text>
        </Card>
      );
    }
    return null;
  }; // . . . . . . . . . . . .

  const CustomizedDot = (props) => { // ● CustomizedDot
    const { cx, cy, datakey } = props;

    if (cx == null || cy == null) return null;
    const SvgComponent = Icons[datakey as keyof typeof Icons];

    if (!SvgComponent) return null;

    return (
      <g transform={`translate(${cx - 15}, ${cy - 15})`}>
        <circle cx="15" cy="15" r="18" fill="gray" stroke="black" strokeWidth="2" />
        <defs>
          <clipPath id={`clip-${datakey}`}>
            <circle cx="15" cy="15" r="15" />
          </clipPath>
        </defs>
        <g clipPath={`url(#clip-${datakey})`}>
          <SvgComponent />
        </g>
      </g>
    );
  };

  const SeriesTooltip: React.FC<TooltipProps<number, string>> = ({ active, payload }) => {  // ● SeriesTooltip
    if (active && payload && payload.length) {

      const Items = payload
        .sort((a, b) => b.value - a.value)
        .map(({ name, value }) => ({ [seriesVData?.keys[name]]: value }));

      return (
        <Card>
          <Text as="div"> <Strong>Ano: </Strong> {payload[0].payload['year']} </Text>
          <Separator my="1" color="gray" size="4" />
          {
            Items.map((item) => {
              const key = Object.keys(item)[0];
              const value = item[key];
              return (
                <Text as="div" key={key}> <Strong>{`${key} :`}</Strong> {value.toLocaleString('de-DE')} </Text>
              )
            })
          }
        </Card >
      );
    }

    return null;
  };

  return (// ── ◯⫘⫘⫘⫘⫘⫘⫘⫘⫘⫘ DOM ⫘⫘⫘⫘⫘⫘⫘⫘⫘⫘⫘⫘⫘⫘➤ 
    <>
      <p // HERE windowSize ↯
        className="fixed right-10 top-30 text-xl text-slate-950 z-50"
      >
        🦀{` wdith: ${windowSize.width}`} <br />
        🦀{` height: ${windowSize.height}`}
      </p>

      <Box
        className={classNames(
          "flex flex-col", // Organiza os painéis filhos em uma coluna
          "p-10 gap-4",
          "h-full w-full bg-neutral-100", // h-full para ocupar a altura disponível, considere 'min-h-screen' se precisar sempre preencher a tela
          "overflow-y-auto" // Permite rolagem se o conteúdo exceder a altura da tela
        )}
      >


        <Box className={classNames(
          "flex items-start",
          "gap-4",
        )}>


          <MapMenu />

          <Box className="flex flex-col flex-1 gap-4 h-[640px]">

            <Box className="flex gap-4 h-2/5">

              <Card id="p1" className="flex-1 bg-purple-300 rounded-xl p-4">
                <Heading as="h3" size="4">Card P1</Heading>
                <Text as="p">Substitua este conteúdo.</Text>
              </Card>

              <Box  // ── ⋙── ── pie ── ──➤
                id='pie'
                className={classNames(
                  'flex-1 rounded-xl',
                  'bg-neutral-400',
                  'overflow-hidden'
                )}
              >
                <ResponsiveContainer width="100%" height="100%">
                  <PieChart>
                    <Pie
                      // ⊙ topVData
                      data={topVData?.percent_data}
                      cx="50%"
                      cy="50%"
                      label={({ percent }) => `${(percent * 100).toFixed(1)}%`}
                      outerRadius="80%"
                      fill="#000"
                      dataKey="v"
                    >
                      {topVData?.percent_data.map((_, index) => (
                        <Cell key={`cell-${index}`} fill={COLORSHEX[variable]?.[index % COLORSHEX[variable].length]} />
                      ))}
                    </Pie>
                    <Tooltip // <○> PieTooltip
                      content={<PieTooltip />}
                    />
                  </PieChart>
                </ResponsiveContainer>
              </Box>

            </Box>

            <Box // ── ⋙── ── bar ── ──➤
              id='bar'
              className={classNames(
                'flex flex-col items-center w-full z-0',
                'rounded-xl bg-emerald-700',
                'flex-1',
                'overflow-hidden p-3'
              )}
            >
              <Text as='div' size="4" highContrast>
                <Strong>{VARIABLES[variable]} </Strong>
              </Text>
              <ResponsiveContainer width="100%" height="100%">
                <BarChart
                  data={topVData?.data} // ⊙ topVData
                  margin={{ top: 20, right: 20, left: 10, bottom: 5, }}
                >
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="name" stroke="#000" />
                  <YAxis stroke="#000" />
                  <Tooltip content={<BarTooltip />} />
                  <Bar name='🦀' dataKey="v" fill="#8884d8" minPointSize={5}>
                    {topVData?.data.map((_, index) => (
                      <Cell key={`cell-${index}`} fill={COLORSHEX[variable]?.[index % COLORSHEX[variable].length]} />
                    ))}
                    <LabelList // (○) BarTopLabels
                      dataKey="name"
                      content={BarTopLabels} />
                  </Bar>
                </BarChart>
              </ResponsiveContainer>
            </Box>
          </Box>

        </Box>


        <Box
          className={classNames(
            "flex items-start", // Organiza px e QPRM_bars lado a lado
            "gap-4",
          )}
        >

          <Card id="px" className="bg-orange-300 rounded-xl p-4 w-1/3 h-[440px]">
            <Heading as="h3" size="4">Card PX</Heading>
            <Text as="p">Este é um card de exemplo para ocupar o espaço à esquerda.</Text>
          </Card>


          <Box // ── ⋙──  ── QPRM_bars ── ──➤
            id='QPRM_bars'
            className={classNames(
              'flex-1 rounded-xl h-[440px]', // flex-1 para ocupar o espaço restante
              'bg-gradient-to-r from-emerald-50 to-green-50',
              'p-4'
            )}
          >
            <ResponsiveContainer width="100%" height="100%">
              <BarChart
                data={topVData?.QP_RM} // ⊙ topVData
                margin={{
                  top: 46,
                  right: 20,
                  left: 20,
                  bottom: 5,
                }}
              >
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="name" />
                <YAxis yAxisId="left" orientation="left" stroke="#AC4D39" />
                <YAxis yAxisId="right" orientation="right" stroke="#FFC53D" />
                <Tooltip // {○} QMRMTootip
                  content={<QMRMTooltip />} />

                <Legend />
                <Bar name='Quantidade Produzida' yAxisId="left" dataKey="qp" fill="#AC4D39" activeBar={<Rectangle stroke="#000" />}  >
                  <LabelList
                    dataKey="name"
                    content={BarTopLabels}  // (○) BarTopLabels

                  />
                </Bar>
                <Bar name="Rendimento Médio" yAxisId="right" dataKey="rm" fill="#FFC53D" activeBar={<Rectangle stroke="#000" />} />
              </BarChart>
            </ResponsiveContainer>
          </Box>
        </Box>


        <Box // ── ⋙── ── TopSeriesBox ── ──➤
          className={classNames(
            "flex",
            'rounded-xl w-full h-[660px] p-10',
            'bg-gradient-to-r from-violet-100 to-fuchsia-100',
          )}
        >

          <ResponsiveContainer width="100%" height="100%">
            <LineChart
              data={seriesVData?.data} // ⊙ seriesVData
              margin={{
                top: 20,
                right: 20,
                left: 20,
                bottom: 20,
              }}
            >
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="year" stroke="#000" />
              <YAxis stroke="#000" scale="log"
                domain={['auto', 'auto']}
              />

              <Tooltip // ○ SeriesTooltip
                content={SeriesTooltip} />

              {seriesKeys.map((key) => (
                <Line
                  key={key}
                  type="monotone"
                  dataKey={key}
                  stroke="#000"
                  // ○ CustomizedDot
                  dot={<CustomizedDot datakey={key} />} />
              ))}

              <Brush
                dataKey="year"
                height={30}
                stroke="#8884d8"
                travellerWidth={10}
              />

            </LineChart>
          </ResponsiveContainer>
        </Box>


      </Box >
    </>
  );

};  // ★ ⋙── ── ── ── ── ── ── ── ── ── ── ── ── ── ── ── ── ──➤
export default Home;

