// HERE INCITE
import classNames from "classnames";
import BG from "../../assets/bg_main2.png";

import {
    Box,
    Heading,
    Text

} from "@radix-ui/themes";
import { animated, useSpring, useTransition } from "react-spring";
import { useRef, useState, useEffect, useMemo } from "react"; // <--- adicione useEffect
import regionData from "../../assets/BahiaRegiao2.json";
import cityData from "../../assets/BahiaCidades4.json";
import { mapStore } from "../../store/mapsStore";


// . . . . . . .
// ğŸ§¿
const SCALE_ADJUSTMENT = 0.35

interface BoundingBox {
    x: number;
    y: number;
    width: number;
    height: number;
}

// Tipagem para regiÃµes
interface Region {
    id: string;
    d: string;
    name: string;
}

// Tipagem para cidades
interface City {
    id: string;
    d: string;
    name: string;
    x: number;
    y: number;
}

// Estrutura de dados que mapeia regiÃµes para um array de cidades
interface CityData {
    [regionId: string]: City[];
}



interface Marker {
    id: string;
    name: string;
    x: number;
    y: number;
}





// [â—] mapCity
const mapCity: CityData = cityData;

// [â—] mapRegion
const mapRegion: Region[] = regionData;



const Incite = () => { // â˜… Incite â‹™â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â¤ 

    const svgRef = useRef<SVGSVGElement | null>(null); // HERE svgRef

    const originalBBoxRef = useRef<BoundingBox | null>(null); // HERE originalBBoxRef


    // â”€â”€ â‹™â”€â”€ â”€â”€ â”€â”€ â”€â”€ â”€â”€ â”€â”€ â”€â”€â¤
    type levels = 0 | 1;
    // âœ³ [currentLevel, setCurrentLevel]
    const [currentLevel, setCurrentLevel] = useState<levels>(0);

    // WARN  EU estou usando esse estado pra nada ??? wut 
    // âœ³ [currentScale, setCurrentScale]
    const [currentScale, setCurrentScale] = useState<number>(1);

    // âœ³ { region, city, setRegion, setCity } 
    const { region, setRegion } = mapStore();

    // âœ³ [markers, setMarkers]
    const [markers, setMarkers] = useState<Marker[]>([]);




    // â”€â”€ â‹™â”€â”€ â”€â”€ â”€â”€ â”€â”€ â”€â”€ â”€â”€ â”€â”€â¤


    // (â—) allCities
    const allCities = useMemo(() => {
        return Object.values(mapCity).flat();
    }, []);  // . . . . . . .





    // (âœª) handleAddMarker
    const handleAddMarker = (cityId: string) => {
        if (!cityId) return; // NÃ£o fazer nada se a opÃ§Ã£o default for selecionada


        // Verificar se um marcador para esta cidade jÃ¡ existe
        const markerExists = markers.some(marker => marker.id === cityId);
        if (markerExists) {
            alert("JÃ¡ existe um marcador para este municÃ­pio!");
            return;
        }


        // Encontrar os dados completos da cidade selecionada
        const cityToAdd = allCities.find(city => city.id === cityId);


        if (cityToAdd) {
            const newMarker: Marker = {
                id: cityToAdd.id,
                name: cityToAdd.name,
                x: cityToAdd.x,
                y: cityToAdd.y
            };

            // Adicionar o novo marcador ao estado
            setMarkers(prevMarkers => [...prevMarkers, newMarker]);
            console.log("Marcador adicionado:", newMarker);

        }
    }; // . . . . . . .




    // âœª bahiaStrokeStyle
    const bahiaStrokeStyle = useSpring({
        opacity: currentLevel === 1 ? 0 : 1,
        config: { duration: 300 } // Ajuste a duraÃ§Ã£o conforme necessÃ¡rio
    });




    // âœª transition
    const transition = useTransition(mapCity[region.active] || [], {
        trail: 600 / mapCity[region.active].length || 1,
        from: { opacity: 0, transform: "scale(0)" },
        enter: { opacity: 1, transform: "scale(1)" },
        leave: { opacity: 0, transform: "scale(0)" },
        config: { mass: 10, tension: 63, friction: 16, clamp: true },
        keys: (mapCity[region.active] || []).map((el) => el.id),
    });


    // âœª springStyles
    const [springStyles, api] = useSpring(() => ({
        transform: `scale(1) translate(0px, 0px)`,
        config: { tension: 62, friction: 35, mass: 7 },
    })); // â”€â”€ â‹™â”€â”€ â”€â”€ â”€â”€ â”€â”€ â”€â”€ â”€â”€ â”€â”€â¤


    useEffect(() => { //HERE uE
        if (svgRef.current && !originalBBoxRef.current) {
            // Assign the value from getBBox to the ref
            originalBBoxRef.current = svgRef.current.getBBox();
            console.log("Original BBox:", originalBBoxRef.current);
        }
    }, []); // . . . . . . .


    // <âœª> runToFit
    const runToFit = (bbox: BoundingBox, rect: BoundingBox) => {
        const svgRect = svgRef.current?.getBoundingClientRect();
        // const svgBox = svgRef.current?.getBBox()
        const svgBox = originalBBoxRef.current; // get the cached svg bbox value

        if (!svgRect || !svgBox) return;

        const CBX = bbox.x + bbox.width / 2;
        const CBY = bbox.y + bbox.height / 2;

        const SVGCX = svgBox.width / 2;
        const SVGCY = svgBox.height / 2;

        // {â—} translate
        // + 5 is the offset from the edge of the canvas
        const translateX = SVGCX - CBX //+ 5;
        const translateY = SVGCY - CBY //+ 5;

        // {â—} Scale
        const scaleX = svgRect.width / rect.width;
        const scaleY = svgRect.height / rect.height;
        const maxScale = Math.min(scaleX, scaleY);

        setCurrentScale(maxScale - SCALE_ADJUSTMENT); // â†º setCurrentScale

        api.start({
            transform: `scale(${maxScale - SCALE_ADJUSTMENT
                }) translate(${translateX}px, ${translateY}px)`,
        });
    }; // â”€â”€ â‹™â”€â”€ â”€â”€ â”€â”€ â”€â”€ â”€â”€ â”€â”€ â”€â”€â¤

    // <âœª> handleClick
    const handleClick = (event) => {
        const target = event.target;
        const target_id = target?.id;
        const target_type = target?.getAttribute("data-type");
        const target_name = target?.getAttribute("data-name");

        // [LOG] target
        // console.log("target:", target);
        console.log("target id:", target_id);
        console.log("target type:", target_type);
        console.log("target name:", target_name);
        console.log("level:", currentLevel);
        console.log("âœ¦â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â¤");

        // . . .
        // âŠ™ currentLevel 0
        if (currentLevel === 0) {



            if (target_type === "region" && target_id !== "bahia_stroke") { // Evitar zoom em bahia_stroke
                setCurrentLevel(1); // â†º setCurrentLevel
                setRegion(target_id, target_name || "");  // â†º setRegion
                if (target.getBBox) { // Checar se getBBox existe
                    runToFit(target.getBBox(), target.getBoundingClientRect()); // {â—‹} runToFit
                }
            }



        } // . . .

        // âŠ™ currentLevel 1
        else if (currentLevel === 1) {
            if (target_type === "city") {
                setCurrentLevel(1); // â†º setCurrentLevel
                // runToFit(target.getBBox(), target.getBoundingClientRect()); // {â—‹} runToFit
                console.log(target_id, "â†¯"); // [LOG] target_id  â†¯
            } else {
                resetMap(); // {â—‹} resetMap
            }
        }
    }  // â”€â”€ â‹™â”€â”€ â”€â”€ â”€â”€ â”€â”€ â”€â”€ â”€â”€ â”€â”€ â”€â”€â¤


    // {âœª} resetMap
    const resetMap = () => {
        setCurrentLevel(0); // â†º setCurrentLevel
        setCurrentScale(1); // â†º setCurrentScale
        setRegion("bahia", "Bahia"); // â†º setRegion
        api.start({
            transform: "scale(1) translate(0px, 0px)",
        });
    };


    return (// â”€â”€ â‹™â‡Œâ‡Œâ‡Œâ‡Œâ‡Œâ‡Œâ‡Œ DOM â‡Œâ‡Œâ‡Œâ‡Œâ‡Œâ‡Œâ‡Œâ‡Œâ‡Œâ‡Œâ«¸
        <>
            <Box // CANVAS â”€â”€ â”€â”€ â”€â”€ â”€â”€â¤
                id="CANVAS"
                className={classNames(
                    "flex h-[600px] flex-col gap-6 ",
                    "mt-40 mx-14 p-4",

                )}
            >

                <Box // . . .  PANEL1
                    id="PANEL1"
                    className="flex w-full">

                    <Box // HERE TEXT_HEADER
                        id="TEXT_HEADER"
                        className="flex flex-col gap-8 pt-10 h-[600px] w-full text-left text ">

                        <Heading color="gray" size="6">
                            Instituto de CiÃªncia, InovaÃ§Ã£o e Tecnologia do Estado da Bahia
                        </Heading>

                        <Heading size="9">
                            Incite - <span className="text-green-900">Agricultura Familiar</span> Diversificada e SustentÃ¡vel
                        </Heading>

                        <Text className="pt-10">
                            Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.
                        </Text>

                    </Box>


                    <Box // HERE LOGO_HEADER
                        id="LOGO_HEADER"
                        className="flex h-[600px] w-full justify-center  "
                        style={{
                            backgroundImage: `url(${BG})`,
                            backgroundSize: "contain",
                            backgroundPosition: "center",
                            backgroundRepeat: "no-repeat",
                        }}
                    >
                        <svg>
                            <circle r={100} cx="50%" cy="50%" fill="#FFEB3B" />
                        </svg>

                    </Box>

                </Box>


                <Box //. . . PANEL2
                    id="PANEL2"
                    className={classNames(
                        // "bg-yellow-700"

                    )}
                >

                    <div // â‹™â”€â”€ â”€â”€ canvas-wrapper â”€â”€ â”€â”€â¤
                        id="canvas-wrapper"
                        className="relative bg-transparent  rounded-3xl"
                        style={{
                            width: "602px",
                            height: "640px",
                            overflow: "hidden",
                            // border: "1px solid black",
                        }}>




                        <Box className="flex items-center gap-4 mb-4 p-4 bg-gray-100 rounded-lg">

                            <Text weight="bold">Adicionar Marcador:</Text>
                            <select
                                onChange={(e) => handleAddMarker(e.target.value)}
                                className="p-2 border rounded-md"
                                defaultValue=""
                            >
                                <option value="" disabled>Selecione um municÃ­pio...</option>
                                {allCities.map(city => (
                                    <option key={city.id} value={city.id}>
                                        {city.name}
                                    </option>
                                ))}
                            </select>

                            <Text size="1" color="gray">
                                {markers.length} marcador(es) adicionado(s)
                            </Text>

                        </Box>





                        <animated.svg //HERE  SVGCanvas
                            id="SVGCanvas"
                            ref={svgRef}
                            viewBox="0 0 602 640"
                            overflow={"visible"}
                            style={{
                                width: "100%",
                                height: "100%",
                                ...springStyles, // â—‹ springStyles
                            }}
                            onClick={handleClick} // (â—‹) handleClick
                        >

                            <g>
                                <defs>
                                    <style>
                                        {
                                            ".cls-1{fill:#f4f4f4;stroke:#a5a5a5}"
                                        }
                                        {
                                            ".cls-1, .cls-2{stroke-linecap:round;stroke-linejoin:round}"
                                        }
                                        {
                                            ".cls-2{fill:none;stroke:#000;stroke-width:2px}"
                                        }
                                    </style>
                                </defs>



                                { // [â—‹] mapRegion
                                    mapRegion.map((el, i) => {
                                        const class_style = el.id === "bahia_stroke" ? "cls-2" : "cls-1 path-hover2"

                                        const strokeSpecificStyle = el.id === "bahia_stroke" ? bahiaStrokeStyle : {};

                                        return (
                                            <g key={i}>
                                                <title>{el.name}</title>
                                                <animated.path
                                                    id={el.id}
                                                    d={el.d}
                                                    data-name={el.name}
                                                    data-type="region"
                                                    className={class_style}
                                                    style={strokeSpecificStyle} // â—‹ bahiaStrokeStyle

                                                />
                                            </g>
                                        )
                                    })
                                }






                                {currentLevel === 1 && (
                                    // HERE Overlay
                                    <rect
                                        opacity={0.95}
                                        x={-2000}
                                        y={-2000}
                                        width="4000"
                                        height="4000"
                                        fill="white"
                                        onClick={(e) => { // Permitir clique no overlay para resetar o mapa
                                            e.stopPropagation(); // Evitar que o clique propague para o SVGCanvas
                                            resetMap();
                                        }}
                                    />
                                )}


                                {transition((style, cityItem) => { // â—‹ transition

                                    return (
                                        <animated.g {...style}>
                                            <title>{cityItem.name}</title>
                                            <animated.path
                                                id={cityItem.id}
                                                d={cityItem.d}
                                                data-name={cityItem.name}
                                                data-type="city"
                                                className={classNames(
                                                    "path-hover2",
                                                    "cls-1",
                                                )}

                                            />
                                        </animated.g>
                                    );
                                })}








                                {markers.map(marker => (
                                    <g key={`marker-${marker.id}`} transform={`translate(${marker.x}, ${marker.y})`}>
                                        <title>Marcador: {marker.name}</title>
                                        <circle
                                            r={3 / currentScale} // Raio do cÃ­rculo (ajustado pelo zoom)
                                            fill="rgba(255, 0, 0, 0.7)" // Cor vermelha semi-transparente
                                            stroke="white" // Borda branca
                                            strokeWidth={0.5 / currentScale} // Largura da borda (ajustada pelo zoom)
                                            style={{ pointerEvents: 'none' }} // Para nÃ£o interferir com cliques no mapa
                                        />
                                    </g>
                                ))}





                            </g>



                        </animated.svg>

                    </div>
                </Box>
            </Box>

        </>
    );
};  // â˜… Incite â‹™â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â¤ 
export default Incite;

